#include "tool.h"
#include "system.h"
#include "ssd1306.h"

#define abs(x) ((x)>0?(x):-(x))

int32_t logfix (uint32_t x){
    int32_t b = 1U << (16 - 1);
    int32_t y = 0;

    if (x == 0) {
        return INT32_MIN; // represents negative infinity
    }

    while (x < 1U << 16) {
        x <<= 1;
        y -= 1U << 16;
    }

    while (x >= 2U << 16) {
        x >>= 1;
        y += 1U << 16;
    }

    uint64_t z = x;

    for (uint8_t i = 0; i < 16; i++) {
        z = z * z >> 16;
        if (z >= 2U << (uint64_t)16) {
            z >>= 1;
            y += b;
        }
        b >>= 1;
    }

    return (y * (uint64_t)0x58b90bfc)>>31;
}

int32_t tempCalc(int16_t a){
    return (0xF6E00000000)/(logfix(((int64_t)a<<32)/((0x1000-a)<<16))+0xD3F94)-0x1112666;
}


uint16_t crc;

void crcf(uint8_t d){
    crc+=d*211;
    crc^=crc>>8;
}


void sendPack(uint8_t type, uint8_t* data, uint8_t len){
    crc=0x0F;
    uartWrite(0x55);
    uartWrite(0x00);
    uartWrite(len);crcf(len);
    uartWrite(type);crcf(type);
    for(uint8_t i=0; i<len; i++){
        uartWrite(data[i]);
        crcf(data[i]);
    }
    uartWrite(crc);
}

const uint8_t numS[] = {15, 9, 15, 15, 18, 15, 15, 15, 18, 15, 3, 3, 10};

const uint8_t num0[] = {
    0xE0, 0xF8, 0xFC, 0x3C, 0x1E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 
    0x1E, 0x3C, 0xFC, 0xF8, 0xE0, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x07, 0x1F, 0x3F, 0x3C, 0x78, 
    0x70, 0x70, 0x70, 0x70, 0x70, 0x78, 0x3C, 0x3F, 0x1F, 0x07
};

const uint8_t num1[] = {
    0x80, 0xC0, 0xE0, 0xF0, 0xF8, 0x7C, 0xFE, 0xFE, 0xFE, 0x01, 
    0x03, 0x03, 0x01, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x7F, 0x7F, 0x7F
};

const uint8_t num2[] = {
    0x70, 0x78, 0x7C, 0x1C, 0x1E, 0x0E, 0x0E, 0x0E, 0x0E, 0x1E, 
    0x1C, 0x7C, 0xF8, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0xC0, 0xE0, 0xF8, 0x7F, 0x1F, 0x0F, 
    0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0xF8, 0x7E, 0x1F, 0x0F, 
    0x03, 0x01, 0x00, 0x00, 0x00, 0x70, 0x78, 0x7E, 0x7F, 0x7F, 
    0x73, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70
};

const uint8_t num3[] = {
    0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 
    0x1C, 0x3C, 0xF8, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0xE0, 0xE0, 
    0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF8, 0xBF, 0x1F, 0x0F, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0x03, 0xFF, 0xFF, 0xFC, 0x70, 0x70, 0x70, 0x70, 0x70, 
    0x70, 0x70, 0x70, 0x70, 0x70, 0x38, 0x3C, 0x1F, 0x0F, 0x03
};

const uint8_t num4[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFE, 0xFE, 0x1E, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x80, 0xF8, 0xFF, 0x7F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFC, 0xFF, 0xFF, 
    0xC3, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xFF, 
    0xC0, 0xC0, 0xC0, 0xC0, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 
    0x01, 0x01, 0x01, 0x01, 0x01, 0x7F, 0x7F, 0x7F, 0x01, 0x01, 
    0x01, 0x01
};

const uint8_t num5[] = {
    0xFE, 0xFE, 0xFE, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 
    0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0xFF, 0xFF, 0xFF, 0xE0, 0xE0, 
    0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xC0, 0xC0, 0x80, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0x03, 0xFF, 0xFF, 0xFC, 0x70, 0x70, 0x70, 0x70, 0x70, 
    0x70, 0x70, 0x70, 0x70, 0x70, 0x38, 0x3C, 0x1F, 0x0F, 0x03
};

const uint8_t num6[] = {
    0x00, 0x00, 0x00, 0xC0, 0xE0, 0xF0, 0x78, 0x3C, 0x1C, 0x1E, 
    0x0E, 0x0E, 0x00, 0x00, 0x00, 0xE0, 0xFC, 0xFF, 0xFF, 0xE3, 
    0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xC0, 0xC0, 0x80, 0x00, 
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x01, 0xFF, 0xFF, 0xFE, 0x07, 0x1F, 0x3F, 0x38, 0x70, 
    0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x38, 0x3F, 0x1F, 0x07
};

const uint8_t num7[] = {
    0x7E, 0x7E, 0x7E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 
    0x0E, 0xFE, 0xFE, 0xFE, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x80, 0xF8, 0xFF, 0x7F, 0x0F, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF8, 0xFF, 0x7F, 
    0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x7C, 0x7F, 0x3F, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const uint8_t num8[] = {
    0x00, 0x00, 0xC0, 0xF0, 0xF8, 0x3C, 0x1C, 0x0E, 0x0E, 0x0E, 
    0x0E, 0x0E, 0x1C, 0x3C, 0xF8, 0xF0, 0xC0, 0x00, 0x00, 0x00, 
    0x07, 0x9F, 0xFF, 0xF8, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 
    0xF0, 0xF8, 0xFF, 0x9F, 0x07, 0x00, 0xF8, 0xFE, 0xFF, 0x07, 
    0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 
    0x07, 0xFF, 0xFF, 0xFC, 0x01, 0x07, 0x0F, 0x1E, 0x3C, 0x38, 
    0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x38, 0x3C, 0x1E, 0x0F, 
    0x07, 0x01
};

const uint8_t num9[] = {
    0xE0, 0xF8, 0xFC, 0x1C, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 
    0x0E, 0x1C, 0xFC, 0xF8, 0xE0, 0x7F, 0xFF, 0xFF, 0x80, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 
    0x00, 0x01, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 
    0xC7, 0xFF, 0xFF, 0x3F, 0x07, 0x00, 0x00, 0x00, 0x70, 0x70, 
    0x78, 0x38, 0x3C, 0x1E, 0x0F, 0x07, 0x03, 0x00, 0x00, 0x00
};

const uint8_t dot[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 
    0x70, 0x70
};

const uint8_t dotdot[] = {
    0x00, 0x00, 0x00, 0x0E, 0x0E, 0x0E, 0xE0, 0xE0, 0xE0, 0x00, 
    0x00, 0x00
};

const uint8_t minus[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

uint8_t numPrint(uint8_t n, uint8_t x){
    const uint8_t *b;
    uint8_t w = numS[n];
    switch(n){
        case 0: b=num0; break;
        case 1: b=num1; break;
        case 2: b=num2; break;
        case 3: b=num3; break;
        case 4: b=num4; break;
        case 5: b=num5; break;
        case 6: b=num6; break;
        case 7: b=num7; break;
        case 8: b=num8; break;
        case 9: b=num9; break;
        case 10: b=dot; break;
        case 11: b=dotdot; break;
        case 12: b=minus; break;
    }
    for(uint8_t i=0; i<w*4; i++)
        SSD1306_Buffer[i%w+(i/w*128)+128*3+x]=b[i];
    return w;
}

void printTemp(int32_t t){
    uint8_t xp;
    uint8_t m=0;
    if(t<0){
        t=-t;
        m=numS[12];
    }
    uint8_t size=m;
    if(t>=10000)size+=numS[t/10000%10]+2;
    if(t>=1000)size+=numS[t/1000%10]+2;
    size+=numS[t/100%10]+2;
    size+=numS[10]+2;
    size+=numS[t/10%10]+2;

    xp=35-size/2;
    if(m)xp+=numPrint(12, xp)+2;
    if(t>=10000)xp+=numPrint(t/1000%10, xp)+2;
    if(t>=1000)xp+=numPrint(t/1000%10, xp)+2;
    xp+=numPrint(t/100%10, xp)+2;
    if(size<68){  
        xp+=numPrint(10, xp)+2;
        xp+=numPrint(t/10%10, xp)+2;
    }
}
