#include "menu.h"
#include "ssd1306.h"

const uint8_t numS[] = {15, 9, 15, 15, 18, 15, 15, 15, 18, 15, 3, 3, 10};

const uint8_t num0[] = {
    0xE0, 0xF8, 0xFC, 0x3C, 0x1E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 
    0x1E, 0x3C, 0xFC, 0xF8, 0xE0, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x07, 0x1F, 0x3F, 0x3C, 0x78, 
    0x70, 0x70, 0x70, 0x70, 0x70, 0x78, 0x3C, 0x3F, 0x1F, 0x07
};

const uint8_t num1[] = {
    0x80, 0xC0, 0xE0, 0xF0, 0xF8, 0x7C, 0xFE, 0xFE, 0xFE, 0x01, 
    0x03, 0x03, 0x01, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x7F, 0x7F, 0x7F
};

const uint8_t num2[] = {
    0x70, 0x78, 0x7C, 0x1C, 0x1E, 0x0E, 0x0E, 0x0E, 0x0E, 0x1E, 
    0x1C, 0x7C, 0xF8, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0xC0, 0xE0, 0xF8, 0x7F, 0x1F, 0x0F, 
    0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0xF8, 0x7E, 0x1F, 0x0F, 
    0x03, 0x01, 0x00, 0x00, 0x00, 0x70, 0x78, 0x7E, 0x7F, 0x7F, 
    0x73, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70
};

const uint8_t num3[] = {
    0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 
    0x1C, 0x3C, 0xF8, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0xE0, 0xE0, 
    0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF8, 0xBF, 0x1F, 0x0F, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0x03, 0xFF, 0xFF, 0xFC, 0x70, 0x70, 0x70, 0x70, 0x70, 
    0x70, 0x70, 0x70, 0x70, 0x70, 0x38, 0x3C, 0x1F, 0x0F, 0x03
};

const uint8_t num4[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFE, 0xFE, 0x1E, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x80, 0xF8, 0xFF, 0x7F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFC, 0xFF, 0xFF, 
    0xC3, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xFF, 
    0xC0, 0xC0, 0xC0, 0xC0, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 
    0x01, 0x01, 0x01, 0x01, 0x01, 0x7F, 0x7F, 0x7F, 0x01, 0x01, 
    0x01, 0x01
};

const uint8_t num5[] = {
    0xFE, 0xFE, 0xFE, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 
    0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0xFF, 0xFF, 0xFF, 0xE0, 0xE0, 
    0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xC0, 0xC0, 0x80, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0x03, 0xFF, 0xFF, 0xFC, 0x70, 0x70, 0x70, 0x70, 0x70, 
    0x70, 0x70, 0x70, 0x70, 0x70, 0x38, 0x3C, 0x1F, 0x0F, 0x03
};

const uint8_t num6[] = {
    0x00, 0x00, 0x00, 0xC0, 0xE0, 0xF0, 0x78, 0x3C, 0x1C, 0x1E, 
    0x0E, 0x0E, 0x00, 0x00, 0x00, 0xE0, 0xFC, 0xFF, 0xFF, 0xE3, 
    0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xC0, 0xC0, 0x80, 0x00, 
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x01, 0xFF, 0xFF, 0xFE, 0x07, 0x1F, 0x3F, 0x38, 0x70, 
    0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x38, 0x3F, 0x1F, 0x07
};

const uint8_t num7[] = {
    0x7E, 0x7E, 0x7E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 
    0x0E, 0xFE, 0xFE, 0xFE, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x80, 0xF8, 0xFF, 0x7F, 0x0F, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF8, 0xFF, 0x7F, 
    0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x7C, 0x7F, 0x3F, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const uint8_t num8[] = {
    0x00, 0x00, 0xC0, 0xF0, 0xF8, 0x3C, 0x1C, 0x0E, 0x0E, 0x0E, 
    0x0E, 0x0E, 0x1C, 0x3C, 0xF8, 0xF0, 0xC0, 0x00, 0x00, 0x00, 
    0x07, 0x9F, 0xFF, 0xF8, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 
    0xF0, 0xF8, 0xFF, 0x9F, 0x07, 0x00, 0xF8, 0xFE, 0xFF, 0x07, 
    0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 
    0x07, 0xFF, 0xFF, 0xFC, 0x01, 0x07, 0x0F, 0x1E, 0x3C, 0x38, 
    0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x38, 0x3C, 0x1E, 0x0F, 
    0x07, 0x01
};

const uint8_t num9[] = {
    0xE0, 0xF8, 0xFC, 0x1C, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 
    0x0E, 0x1C, 0xFC, 0xF8, 0xE0, 0x7F, 0xFF, 0xFF, 0x80, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 
    0x00, 0x01, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 
    0xC7, 0xFF, 0xFF, 0x3F, 0x07, 0x00, 0x00, 0x00, 0x70, 0x70, 
    0x78, 0x38, 0x3C, 0x1E, 0x0F, 0x07, 0x03, 0x00, 0x00, 0x00
};

const uint8_t dot[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 
    0x70, 0x70
};

const uint8_t dotdot[] = {
    0x00, 0x00, 0x00, 0x0E, 0x0E, 0x0E, 0xE0, 0xE0, 0xE0, 0x00, 
    0x00, 0x00
};

const uint8_t minus[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

uint8_t numPrint(uint8_t n, uint8_t x){
    const uint8_t *b;
    uint8_t w = numS[n];
    switch(n){
        case 0: b=num0; break;
        case 1: b=num1; break;
        case 2: b=num2; break;
        case 3: b=num3; break;
        case 4: b=num4; break;
        case 5: b=num5; break;
        case 6: b=num6; break;
        case 7: b=num7; break;
        case 8: b=num8; break;
        case 9: b=num9; break;
        case 10: b=dot; break;
        case 11: b=dotdot; break;
        case 12: b=minus; break;
        default: b=minus;
    }
    for(uint8_t i=0; i<w*4; i++)
        SSD1306_Buffer[i%w+(i/w*128)+128*3+x]=b[i];
    return w;
}

void printTemp(int32_t t){
    uint8_t xp;
    uint8_t m=0;
    if(t<0){
        t=-t;
        m=numS[12];
    }
    uint8_t size=m;
    if(t>=10000)size+=numS[t/10000%10]+2;
    if(t>=1000)size+=numS[t/1000%10]+2;
    size+=numS[t/100%10]+2;
    size+=numS[10]+2;
    size+=numS[t/10%10]+2;

    xp=37-size/2;
    if(m)xp+=numPrint(12, xp)+2;
    if(t>=10000)xp+=numPrint(t/1000%10, xp)+2;
    if(t>=1000)xp+=numPrint(t/1000%10, xp)+2;
    xp+=numPrint(t/100%10, xp)+2;
    if(size<68){  
        xp+=numPrint(10, xp)+2;
        xp+=numPrint(t/10%10, xp)+2;
    }
}

void drawWait(uint16_t t){
    uint8_t xp=63-(numS[t/600%10]+numS[t/60%10]+9);
    ssd1306_SetCursor(64-sizeof(WAIT_MSG)/2*7,4);
    ssd1306_WriteString(WAIT_MSG, Font_7x9, White);
    ssd1306_DrawRect(0, 0, 127, 63, 1);
    ssd1306_DrawLine(0, 16, 127, 16, 1);
    xp+=numPrint(t/600%10, xp)+2;
    xp+=numPrint(t/60%10, xp)+6;
    xp+=numPrint(11, xp)+6;
    xp+=numPrint(t%60/10%10, xp)+2;
    numPrint(t%10, xp);
}

void drawErr(uint8_t err){
    char bufC[40];
    ssd1306_DrawRect(0, 0, 127, 63, 1);
    ssd1306_DrawLine(0, 16, 127, 16, 1);
    xsprintf(bufC, "Ошибка:E%u", err);
    ssd1306_SetCursor(32,4);
    ssd1306_WriteString(bufC, Font_7x9, White);
    ssd1306_SetCursor(INDENT, 20);
    switch(err){
        case 0:  ssd1306_WriteString("-", Font_7x9, White); break;
        case 1:  ssd1306_WriteString("Аварийный сигнал внутреннего вентилятора", Font_7x9, White); break;
        case 2:  ssd1306_WriteString("Аварийный сигнал 2 внутреннего вентилятора", Font_7x9, White); break;
        case 3:  ssd1306_WriteString("Аварийный сигнал внешнего вентилятора", Font_7x9, White); break;
        case 4:  ssd1306_WriteString("Аварийный сигнал 2 внешнего вентилятора", Font_7x9, White); break;
        case 5:  ssd1306_WriteString("Аварийный сигнал слабого тока компрессора", Font_7x9, White); break;
        case 6:  ssd1306_WriteString("Аварийный сигнал превышения тока компрессора", Font_7x9, White); break;
        case 7:  ssd1306_WriteString("Аварийный сигнал датчика внутренней температуры", Font_7x9, White); break;
        case 8:  ssd1306_WriteString("-", Font_7x9, White); break;
        case 9:  ssd1306_WriteString("Аварийный сигнал датчика температуры конденсатора", Font_7x9, White); break;
        case 10: ssd1306_WriteString("Аварийный сигнал высокой температуры", Font_7x9, White); break;
        case 11: ssd1306_WriteString("Аварийный сигнал низкой температуры", Font_7x9, White); break;
        case 12: ssd1306_WriteString("-", Font_7x9, White); break;
        case 13: ssd1306_WriteString("Аварийный сигнал панели управления", Font_7x9, White); break;
        case 14: ssd1306_WriteString("Аварийный сигнал низкого тока нагревателя", Font_7x9, White); break;
        case 15: ssd1306_WriteString("Аварийный сигнал превышения тока нагревателя", Font_7x9, White); break;
    } 
}
void drawMain(int16_t t, uint16_t rmp, uint16_t v, uint16_t a){
    ssd1306_DrawRect(0, 0, 127, 63, 1);
    ssd1306_DrawLine(0, 16, 127, 16, 1);
    ssd1306_DrawLine(70, 16, 70, 63, 1);
    ssd1306_DrawLine(70, 42, 127, 42, 1);
    ssd1306_DrawLine(97, 42, 97, 63, 1);
    ssd1306_SetCursor(64-sizeof(WAIT_MSG)/2*7,4);
    ssd1306_WriteString(WAIT_MSG, Font_7x9, White);

    ssd1306_SetCursor(75, 26);
    xprintf("%04dRPM", rmp);

    ssd1306_SetCursor(75, 49);
    xprintf("%uV", v/100%100);

    ssd1306_SetCursor(103, 49);
    xprintf("%uA", a/100%100);

    printTemp(t);
}

void drawDebug(int32_t a1, int32_t a2, int32_t a3, int32_t a4, int32_t a5, int32_t a6){
    ssd1306_SetCursor(INDENT, 0);
    xprintf("A1=%u\nA2=%d\nA3=%d\nA4=%d\nV=%d.%03d\nA6=%u\n", a1, a2, a3, a4, a5/1000, a5%1000, a6);
}
